<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UMAP vs t-SNE 3D Visualization</title>

  <!-- 1) Bootstrap CSS for layout, cards & utilities -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- 2) Plotly.js for the 3D scatter plots -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding-top: 1rem;
      padding-bottom: 1rem;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Title + Settings button -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3 m-0">UMAP vs t-SNE 3D</h1>
      <button
        class="btn btn-outline-secondary"
        data-bs-toggle="offcanvas"
        data-bs-target="#settings"
        aria-controls="settings"
      >
        ⚙️ Settings
      </button>
    </div>

    <!-- Grid: two cols on md+, one on sm -->
    <div class="row gx-3 gy-4">
      <!-- UMAP card -->
      <div class="col-12 col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-primary text-white">UMAP</div>
          <div id="umap" class="card-body p-0" style="height:500px;"></div>
        </div>
      </div>

      <!-- t-SNE card -->
      <div class="col-12 col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-success text-white">t-SNE</div>
          <div id="tsne" class="card-body p-0" style="height:500px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Offcanvas sidebar for controls -->
  <div
    class="offcanvas offcanvas-start"
    tabindex="-1"
    id="settings"
    aria-labelledby="settingsLabel"
  >
    <div class="offcanvas-header">
      <h5 id="settingsLabel">Controls</h5>
      <button
        type="button"
        class="btn-close"
        data-bs-dismiss="offcanvas"
        aria-label="Close"
      ></button>
    </div>
    <div class="offcanvas-body">
      <div class="mb-3">
        <label for="markerSize" class="form-label">Marker size:</label>
        <input
          type="range"
          class="form-range"
          id="markerSize"
          min="1"
          max="10"
          value="4"
        />
      </div>
      <!-- Add more controls here if you like -->
    </div>
  </div>

  <!-- Bootstrap JS (includes Popper) for offcanvas -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>

  <script>
    // 1) Define your colors
    const COLORS = {
      High:     "#FDE725",
      Moderate: "#7AD151",
      Low:      "#22A884",
    };

    // 2) Common layout & modebar config
    const COMMON_LAYOUT = {
      margin: { t: 40, b: 20, l: 0, r: 0 },
      scene: { xaxis: {}, yaxis: {}, zaxis: {} },
      legend: {
        x: 0.02,
        y: 0.98,
        bgcolor: "rgba(255,255,255,0.8)",
        bordercolor: "#ccc",
        borderwidth: 1,
      },
      template: "plotly_white",
    };
    const COMMON_CONFIG = {
      responsive: true,
      displayModeBar: true,
      displaylogo: false,
      modeBarButtonsToAdd: ["resetCameraDefault", "zoom3d", "pan3d"],
    };

    // 3) Fetch & plot function (group by Potency_Bucket)
    function plotData(url, divId) {
      fetch(url)
        .then((r) => r.json())
        .then((data) => {
          // Group records by bucket
          const groups = {};
          data.forEach((pt) => {
            const b = pt.Potency_Bucket || "Unknown";
            (groups[b] = groups[b] || []).push(pt);
          });

          // Build one trace per bucket
          const traces = Object.entries(groups).map(([bucket, pts]) => ({
            x: pts.map((p) => p.x),
            y: pts.map((p) => p.y),
            z: pts.map((p) => p.z),
            text: pts.map((p) => `${bucket}: ${p.id || ""}`),
            name: bucket,
            mode: "markers",
            type: "scatter3d",
            marker: {
              size: +document.getElementById("markerSize").value,
              color: COLORS[bucket] || "#888",
              opacity: 0.7,
            },
          }));

          Plotly.newPlot(divId, traces, COMMON_LAYOUT, COMMON_CONFIG);
        })
        .catch((err) => {
          console.error(err);
          document.getElementById(divId).innerHTML =
            "<p class='text-danger p-3'>Failed to load data.</p>";
        });
    }

    // 4) Initial plots
    plotData("umap_embedding.json", "umap");
    plotData("tsne_embedding.json", "tsne");

    // 5) Marker‐size slider hookup
    document
      .getElementById("markerSize")
      .addEventListener("input", (e) => {
        const newSize = +e.target.value;
        Plotly.restyle("umap", { "marker.size": newSize });
        Plotly.restyle("tsne", { "marker.size": newSize });
      });
  </script>
</body>
</html>
