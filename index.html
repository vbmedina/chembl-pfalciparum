<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChEMBL: Plasmodium falciparum Dashboard</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Plotly.js -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
    }
    .plot-3d {
      width: 100%;
      height: 60vh;
    }
    .pie-container {
      width: 100%;
      height: 400px;
    }
  </style>
</head>

<body>
  <div class="container mb-5">
    <h1 class="display-6 text-center mb-3">
      Associated Bioactivities (n = 969 219)
    </h1>
    <div id="bioPieChart" class="pie-container"></div>
  </div>

  <div class="container mb-5">
    <h1 class="display-6 text-center mb-3">
      IC₅₀ Hits vs Deletions
    </h1>
    <div id="prepPieChart" class="pie-container"></div>
  </div>

  <div class="container">
    <h1 class="h4 mb-4 text-center">UMAP vs t-SNE 3D (Potency Buckets)</h1>
    <div class="row gy-4">
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">UMAP</div>
          <div id="umap" class="card-body p-0 plot-3d"></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-header bg-success text-white">t-SNE</div>
          <div id="tsne" class="card-body p-0 plot-3d"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==== 1) BIOACTIVITY PIE ====
    const bioLabels = [
      'Potency','Inhibition','Z score','INHIBITION','Percent Effect',
      'Activity','Ratio IC50','IC90','ED50','MIC','GI','Ratio',
      'AbsAC35','Ratio EC50','Growth Inhibition','Relative activity',
      'Log RA','Other'
    ];
    const bioValues = [
      302506,201067,147592,133425,74710,
      3324,2317,1558,1242,775,732,630,
      469,412,400,283,211,1577
    ];
    const bioColors = [
      '#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd',
      '#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf',
      '#aec7e8','#ffbb78','#98df8a','#ff9896','#c5b0d5',
      '#c49c94','#f7b6d2','#c7c7c7'
    ];

    Plotly.newPlot('bioPieChart', [{
      type: 'pie',
      labels: bioLabels,
      values: bioValues,
      marker: { colors: bioColors },
      textinfo: 'label+percent',
      insidetextorientation: 'radial',
      sort: false
    }], {
      margin: { t:0, b:0, l:0, r:200 },      // extra right margin
      legend: { x:1.02, y:0.5 },             // push legend outside
      paper_bgcolor: 'white',
      plot_bgcolor: 'white',
      template: 'plotly_white'
    }, {
      responsive: true,
      displayModeBar: false
    });


    // ==== 2) PREPROCESSING PIE ====
    const prepLabels = [
      'IC₅₀ Hits', 'Deleted: Strains','Deleted: Missing IC₅₀',
      'Deleted: Sexual Stage','Deleted: SMILES'
    ];
    const prepValues = [57490,5034,10449,1608,75];
    const prepColors = [
      '#636efa','#ffa15a','#00cc96','#ab63fa','#19d3f3'
    ];

    Plotly.newPlot('prepPieChart', [{
      type: 'pie',
      labels: prepLabels,
      values: prepValues,
      marker: { colors: prepColors },
      textinfo: 'label+percent',
      sort: false
    }], {
      margin: { t:0, b:0, l:0, r:200 },
      legend: { x:1.02, y:0.5 },
      template: 'plotly_white'
    }, {
      responsive: true,
      displayModeBar: false
    });


    // ==== 3) UMAP/t-SNE 3D SETTINGS ====
    const COLORS = {
      High:     '#FDE725',
      Moderate: '#7AD151',
      Low:      '#22A884'
    };
    const LAYOUT3D = {
      margin: { t:40, b:20, l:0, r:0 },
      scene: { xaxis:{}, yaxis:{}, zaxis:{} },
      legend: {
        x:0.02, y:0.98,
        bgcolor:'rgba(255,255,255,0.8)',
        bordercolor:'#ccc',
        borderwidth:1
      },
      paper_bgcolor: 'white',
      plot_bgcolor: 'white',
      template:'plotly_white'
    };
    const CONFIG3D = {
      responsive: true,
      displayModeBar: true,      // always on
      displaylogo: false,
      modeBarButtonsToAdd: [
        'resetCameraDefault','zoom3d','pan3d'
      ]
    };

    function plot3D(url, divId) {
      // purge any old plot
      Plotly.purge(divId);

      fetch(url)
        .then(r => r.json())
        .then(data => {
          // group by Potency_Bucket
          const groups = {};
          data.forEach(pt => {
            const b = pt.Potency_Bucket;  // must exactly match your JSON key
            (groups[b] = groups[b] || []).push(pt);
          });

          const traces = Object.entries(groups).map(([bucket, pts]) => ({
            x:    pts.map(p=>p.x),
            y:    pts.map(p=>p.y),
            z:    pts.map(p=>p.z),
            name: bucket,
            mode: 'markers',
            type: 'scatter3d',
            marker: {
              size:    4,
              color:   COLORS[bucket] || '#999',
              opacity: 0.8
            }
          }));

          Plotly.newPlot(divId, traces, LAYOUT3D, CONFIG3D);
        })
        .catch(err => console.error(`Error loading ${divId}:`, err));
    }

    // draw both
    plot3D('umap_embedding.json','umap');
    plot3D('tsne_embedding.json','tsne');
  </script>
</body>
</html>
